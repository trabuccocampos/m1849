<!-- /templates/product.liquid -->
<div itemscope itemtype="http://schema.org/Product">
  <meta itemprop="url" content="{{ shop.url }}{{ product.url }}">
  <meta itemprop="image" content="{{ product.featured_image.src | img_url: 'grande' }}">

  {% assign current_variant = product.selected_or_first_available_variant %}

  <div class="grid product-single">
    <div class="grid__item large--eight-twelfths medium--one-whole text-center">
      {% include 'product-images' %}
    </div>
    <div class="grid__item product-single__meta--wrapper medium--one-whole large--four-twelfths">
      <div class="product-single__meta">
        {% if settings.product_vendor_enable %}
          <h2 class="product-single__vendor" itemprop="brand">{{ product.vendor }}</h2>
        {% endif %}

        <h1 class="product-single__title color-code" itemprop="name">{{ product.title }}</h1>
        <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
          {% comment %}
            Optionally show the 'compare at' or original price of the product.
          {% endcomment %}

          {% comment %}
            {% if product.compare_at_price > product.price %}
              <span class="product-single__price--wrapper">
                <span class="visually-hidden">{{ 'products.general.regular_price' | t }}</span>
                <span id="ComparePrice" class="product-single__price--compare-at">
                  {{ product.compare_at_price | money }}
                </span>
                <span class="visually-hidden">{{ 'products.general.sale_price' | t }}</span>
              </span>
            {% endif %}
          {% endcomment %}
        </div>

        <div class="product-single__description rte" itemprop="description">
          {% comment%}

            -- Getting Collections --
            In order to get the bottom level collection, we're finding the collection
            that only has one product type and that product is exactly the product
            type of our current product.

            The top level collection is found based on if every product from the bottom
            level collection is found within the top level. This ensures that other
            collections such as 'all' or 'newest' won't corrupt the fetching of these collections.

          {% endcomment%}
          {% for collection in product.collections %}
            {% if collection.all_types.size == 1 && collection.all_types contains product.type %}
              {% assign bottom_level_collection = collection %}
            {% endif %}
          {% endfor %}

          {% for collection in product.collections %}
            {% unless collection.id == bottom_level_collection.id %}
              {% assign match = true %}
              {% for _product in bottom_level_collection.products %}
                {% assign collection_ids = _product.collections | map: "id" %}
                {% unless collection_ids contains collection.id %}
                  {% assign match = false %}
                {% endunless %}
              {% endfor %}

              {% if match %}
                {% assign top_level_collection = collection%}
              {% endif %}
            {% endunless %}
          {% endfor %}

          <div class="collections">
            <h3><a href="{{ bottom_level_collection.url }}">{{ bottom_level_collection.title }}</a></h3>
            <h4><a href="{{ top_level_collection.url }}">{{ top_level_collection.title }}</a></h4>
          </div>
          {% if product.tags contains 'M49' or product.tags contains 'm49' %}
            <a href="/collections/all/M49" class="btn btn__m49">M49</a>
          {% endif %}
          {{ product.description }}
        </div>
        <div class="specs tabular">
          {% assign made_in_places = "italy,asia" | split: "," %}
          <div class="tabs">
            {% assign first_tab = true %}
            {% for place in made_in_places %}
              {% assign place_fields = product.metafields[place] | size %}
              {% if place_fields > 0 %}
                <a href="#{{place}}" class="{% if first_tab %}active{% endif %}" data-tab="{{ place }}">{{ place | capitalize }}</a>
                {% assign first_tab = false %}
              {% endif %}
            {% endfor %}
          </div>
          <div class="tab-content">
            {% assign first_tab = true %}

            {% assign fields = "color_code,thickness,size,front,temple,notes" | split: "," %}
            {% for place in made_in_places %}
              {% assign place_fields = product.metafields[place] | size %}
              {% if place_fields > 0 %}
                <div class="tab {% if first_tab %}active{% endif %}" data-tab="{{ place }}">
                  <table>
                    <tbody>
                      {% for key in fields %}
                        {% assign field = product.metafields[place][key] %}
                        {% if field %}
                          <tr>
                            {% assign humanized_key = key | split: "_" %}
                            <td>{% for word in humanized_key %}{{word | capitalize}} {% endfor %}</td>
                            <td {% if field == "color_code" %}data-color-code="{{ field }}"{% endif %}>
                              {% assign link_keys = "temple,front" | split: ","  %}
                              {% if link_keys contains key %}
                                <a href="/products/{{ field }}">{{ field }}</a>
                              {% else %}
                                {{ field }}
                              {% endif %}
                            </td>
                          </tr>
                        {% endif %}
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% assign first_tab = false %}
              {% endif %}
            {% endfor %}
          </div>
        </div>

        {% include 'product-form' %}
      </div>
    </div>
  </div>

</div>
<!-- Product Div closed above -->
</div>
<!-- Wrapper div closed above -->

<!-- whole width panel -->
<div class="related-products__wrapper noprint">
    <div class="wrapper">
      <div class="product-extras related-lookbooks grid">
      <div class="grid__item large--one-third small--one-whole" data-relatable="product.article" data-relatable-id="{{product.id}}">
        {% raw %}
          {{#article}}
            <h3>Featured In</h3>
          {{/article}}
          <div class="lookbooks-container">
            {{#article}}
              <a href="/blogs/lookbook/{{article.id}}" class="product-lookbook">
                <img src="{{article.image.src}}" alt="">
                <h3>{{article.title}}</h3>
                <p>{{{article.summary_html}}}</p>
              </a>
            {{/article}}
          </div>
        {% endraw %}
      </div>
      <div class="grid__item large--one-third medium--one-third small--one-whole">
        <a class="print-item" href="javascript:window.print()">
          <svg width="74px" height="53px" viewBox="723 788 74 53" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="icon-print">
              <!-- Generator: Sketch 3.8.3 (29802) - http://www.bohemiancoding.com/sketch -->
              <desc>Material card icon</desc>
              <defs></defs>
              <polygon id="Rectangle-28" fill="none" transform="translate(759.992959, 814.211268) rotate(-90.000000) translate(-759.992959, -814.211268) " points="735.345072 779.359154 784.640846 779.359154 784.640846 839.874309 775.57352 849.063381 735.345072 849.063381"></polygon>
              <polyline id="Path-277" fill="none" transform="translate(789.577174, 794.205689) rotate(-90.000000) translate(-789.577174, -794.205689) " points="784.880565 798.782863 784.880565 789.628515 794.273782 789.628515"></polyline>
              <rect id="Rectangle-30" fill-rule="evenodd" x="731" y="796" width="39" height="36"></rect>
              <path d="M776.352113,816.056338 L787.5,816.056338" id="Line" stroke-linecap="square" fill="none"></path>
              <path d="M776.352113,823.056338 L787.5,823.056338" id="Line" stroke-linecap="square" fill="none"></path>
              <path d="M776.352113,830.056338 L787.5,830.056338" id="Line" stroke-linecap="square" fill="none"></path>
          </svg>
          <h3>Print Materials Card</h3>
        </a>
      </div>
      <div class="grid__item large--one-third small--one-whole">
        <div class="attachments">
          {% if product.tags contains 'M49' %}
            <a href="{{ settings.global_m49_spec_url }}">
              <svg width="53px" height="74px" viewBox="976 777 53 74" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="icon-specifications">
                  <!-- Generator: Sketch 3.8.3 (29802) - http://www.bohemiancoding.com/sketch -->
                  <desc>Specifications Icon</desc>
                  <defs></defs>
                  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(978.000000, 779.000000)">
                      <polygon id="Rectangle-28" points="0 0 49.2957746 0 49.2957746 60.5151557 40.2284486 69.7042277 0 69.7042277"></polygon>
                      <polyline id="Path-277" points="39.9568572 69.0135025 39.9568572 59.8591549 49.3500743 59.8591549"></polyline>
                      <path d="M7.3943662,8.09859155 L41.5511118,8.09859155" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,22.1830986 L41.5511118,22.1830986" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,15.1408451 L41.5511118,15.1408451" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,29.2253521 L41.5511118,29.2253521" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,36.2676056 L41.5511118,36.2676056" id="Line" stroke-linecap="square"></path>
                  </g>
              </svg>
              <h3>Specifications</h3>
            </a>
          {% else %}
            <a href="{{ settings.global_spec_url }}">
              <svg width="53px" height="74px" viewBox="976 777 53 74" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="icon-specifications">
                  <!-- Generator: Sketch 3.8.3 (29802) - http://www.bohemiancoding.com/sketch -->
                  <desc>Specifications Icon</desc>
                  <defs></defs>
                  <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd" transform="translate(978.000000, 779.000000)">
                      <polygon id="Rectangle-28" points="0 0 49.2957746 0 49.2957746 60.5151557 40.2284486 69.7042277 0 69.7042277"></polygon>
                      <polyline id="Path-277" points="39.9568572 69.0135025 39.9568572 59.8591549 49.3500743 59.8591549"></polyline>
                      <path d="M7.3943662,8.09859155 L41.5511118,8.09859155" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,22.1830986 L41.5511118,22.1830986" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,15.1408451 L41.5511118,15.1408451" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,29.2253521 L41.5511118,29.2253521" id="Line" stroke-linecap="square"></path>
                      <path d="M7.3943662,36.2676056 L41.5511118,36.2676056" id="Line" stroke-linecap="square"></path>
                  </g>
              </svg>
              <h3>Specifications</h3>
            </a>
          {% endif %}
          {% for attachment in product.metafields.attachments %}
            {% unless attachment == blank %}
              <a href="{{ attachment[1] }}" class="btn">{{ attachment[0] | capitalize }}</a>
            {% endunless %}
          {% endfor %}
        </div>
      </div>
    </div>
  </div>
</div>

<div class="wrapper">
  {% if bottom_level_collection %}
    <div class="product-extras related-products">
      <h3>
        Products in Collection
        <a href="{{ product.collections.first.url }}" class="more-styles">{{ bottom_level_collection.products.size }} colors in Collection</a>
      </h3>
      <div class="slick-items">
        {% for _product in bottom_level_collection.products %}
          {% unless _product.id == product.id %}
            <div class="related-product product-card">
              <a href="{{ _product.url }}">
                {% if _product.featured_image %}
                  {% assign img_url = _product.featured_image | img_url: "compact" %}
                {% else %}
                  {% assign img_url = 'no-image-compact.png' | asset_url %}
                {% endif %}
                <img src="{{ img_url }}" alt="{{ product.title | escape }}" />
              </a>
            </div>
          {% endunless %}
        {% endfor %}
      </div>
    </div>
  {% endif %}
  {% if collection %}
    <hr class="hr--clear">
    <div class="text-center">
      <a href="{{ collection.url }}" class="return-link">&larr; {{ 'products.general.collection_return' | t: collection: collection.title }}</a>
    </div>
  {% endif %}

</div>

<div class="grid">
  <div class="grid__item large--two-thirds push--large--one-sixth disclaimer">
    <p>
      We strive to make our colors as accurate as possible, but screen images are intended as a guide only and should not be regarded as absolutely correct. Some of the pictures drawn out of the main images, as well as animations, included in the catalogue may not reflect the final product. It is therefore recommended to request a sample before proceeding with the order.
    </p>
  </div>
</div>

{% comment %}

  *IMPORTANT:*
  This theme uses a customized version of `option_selection.js` to support using radio inputs for
  color and size variants. The custom version is in `variant_selection.js`.

  If you wish to enable the default dropdowns for size and color
  you can change the liquid asset tag below from:

  {{ 'variant_selection.js' | asset_url | script_tag }}

  to

  {{ 'option_selection.js' | shopify_asset_url | script_tag }}

  If you use the default `option_selection.js` the labels for the dropdowns will
  appear outside the dropdown.

  You will also need to change `.radio-wrapper` to `.selector-wrapper` below.

  {{ 'variant_selection.js' | asset_url | script_tag }}
{% endcomment %}

<script>
  // var selectCallback = function(variant, selector) {
  //   timber.productPage({
  //     money_format: "{{ shop.money_format }}",
  //     variant: variant,
  //     selector: selector,
  //     translations: {
  //       addToCart : {{ 'products.product.add_to_cart' | t | json }},
  //       soldOut : {{ 'products.product.sold_out' | t | json }},
  //       unavailable : {{ 'products.product.unavailable' | t | json }}
  //     }
  //   });
  // };
  //
  // jQuery(function($) {
  //   new Shopify.OptionSelectors('ProductSelect', {
  //     product: {{ product | json }},
  //     onVariantSelected: selectCallback,
  //     enableHistoryState: true
  //   });
  //
  //   // Add label if only one product option and it isn't 'Title'. Could be 'Size'.
  //   {% if product.options.size == 1 and product.options.first != 'Title' %}
  //     $('.radio-wrapper:eq(0)').prepend('<label for="ProductSelect-option-0" class="single-option-radio__label">{{ product.options.first | escape }}</label>');
  //   {% endif %}
  //
  //   // Hide drop-down selectors if we only have 1 variant and its title contains 'Default'.
  //   {% if product.variants.size == 1 and product.variants.first.title contains 'Default' %}
  //     $('.selector-wrapper').hide();
  //   {% endif %}
  // });
</script>
